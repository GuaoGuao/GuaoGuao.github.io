---
title: 计算机网络
date: 2020-04-26 15:43:36
tags:
---

# 计算机网络概述
#### 局域网、广域网、Internet
* 局域网： 覆盖范围小，不超过100米，带宽固定 10M/100M/1000M，自己维护
* 广域网： 距离远，花钱租带宽，服务商维护
* Internet： 运营商（ISP）有机房提供接入服务，跨运营商访问慢，大厂有自己的双线机房、比较快

#### 数据通信过程
* 数据包中存在发送方ip和目标ip，数据帧中存在数据包内容和发送方mac地址和目标mac地址
* 路由器根据数据帧中的ip地址网段寻找下一跳目标，修改发送方mac和目标mac地址转发到目标路由
* 数据包最大150k，数据较大时会拆分数据为多个包发送，发送时先放入网卡缓存，一个一个发送，发送成功后等待目标收到的消息，收到消息即为发送成功，再从缓存中删除，才有下一个包进入缓存

#### OSI参考模型
* 应用层： 产生网络流量的程序
* 视图层： 在传输之前加密/压缩
* 会话层： 与网站建立的会话
* 传输层： 可靠传输、流量控制、不可靠传输
* 网络层： 选择最佳路径，规划ip地址
* 数据链路层： 数据帧的开始和结束，差错校验     mac冲突
* 物理层： 电器特性、接口标准

#### TCP/IP协议栈
其原理就是发送方层层封装，接收方层层解封的过程
![1](/public/images/Image.png)
![1](/public/images/Image&#32;[1].png)
![1](/public/images/Image&#32;[2].png)

#### 性能指标

1. 速率/比特率： 在数字信道上每秒传送的比特(bit)数，
2. 带宽： 数字信道能传送的最高数据率
3. 吞吐量： 单位时间内通过某个网络的数据量，即该网络上所有信道速率之和
4. 时延/延迟：
    1. 发送时延： 网卡到网线上（数据块长度÷带宽），花钱提高带宽是减小这个时延
    2. 传播时延： 网线上（与传播介质相关）
    3. 处理时延： 路由器上处理转发
    4. 排队时延： 路由器上的排队
    5. 时延带宽积： 传播时延×带宽（即数据在网线上占多长）
    6. 往返时间： 发送方发送时间到发送方收到发送成功消息的时间
    7. 利用率
        1. 信道利用率： 有数据通过时间÷（有+无）数据通过时间
        2. 网络利用率： 信道利用率加权平均值
 
# 物理层

#### 基本概念

* 如何在传输媒体上传输数据比特流
* 机械特性（大小、接口）、电器特性（电压）、功能特性（电压标准含义）、过程特性（功能步骤）
* 码元： 某个时间点的基本波形，可以代表n个bit的数据
* 信道
    * 单向通信（单工通信）
    * 双向交替通信（半双工通信）： 对讲机
    * 双向同事通信（全双工通信）： 打电话
   
#### 基础知识

* 基带信号和带通信号
    * 基带信号： 信源的信号，频段较低，衰减较大，传播距离近
    * 带通信号： 基带信号经过载波调制，频段较高，衰减较小，能够在信道中传播较远，调制方法三种：
    * ![1](/public/images/Image&#32;[3].png)
* 常用编码，单双极性即低电平为0还是-A，归零即没有信号的时候电平是否跳0
    * 单极性不归零码
    * 双极性不归零码
    * 单极性归零码
    * 双极性归零吗
    * 曼彻斯特编码： 一个时钟周期内跳变到0或者1，上升沿和下降沿的概念
    * 查分曼彻斯特编码： 有跳变就是1，没有跳变就是0，类似异或的概念，抗干扰性强
    * ![1](/public/images/Image&#32;[4].png)
* 奈氏准则（奈奎斯特）：他提出了在假定的理想条件（没有干扰的情况下）下，为了避免码间串扰，码元的传输速率的上限值。
* 信噪比： 有白噪声的情况下用香农公式能够获取极限传输速率
    * ![1](/public/images/Image&#32;[5].png)

#### 传输媒体

* 导向传输媒体： 电磁波，沿着固体媒体传播
    * 双绞线
        * 屏蔽双绞线 STP
        * 无屏蔽双绞线 UTP
    * 同轴电缆
        * 50欧 同轴电缆（基带同轴电缆）多用于数字传输，基带传输
        * 75欧 同轴电缆（宽带同轴电缆） 模拟传输
    * 光缆
        * 多模光纤： 多个电磁波模式，光纤粗
        * 单模光纤： 单个电磁波模式，光纤细，传播特性好，10GHz
* 恍然大悟的感觉
    * 两台电脑如何直接连起来，要用交叉线连接，因为网线的端口是有顺序的，比如端口1是发，端口2是收，那连另一台电脑应该用1端口连2端口，如果用直通线相连是不行的，要反序，即交叉线
* 非导向传输媒体，无线传输，卫星通信
* 集线器
    是一个大的冲突域，一个时间点只能两台计算器通信，类似网线的功能，只有传播，没有判断和转发
    
#### 信道复用技术

 * 频分复用 FDM： 即所有用户在同样的时间占用不同的带宽资源，发送方在调制解调器上用不同的频率调制信号，合成一个总的波形发送，接收方用相应的频率过滤，解调成不同的信号
* 时分复用 TDM： 即所有用户在不同的时间占用同样的频带宽度，发送方将信号分为一段段等长的时分复用帧，所有用户周期性的生成总信号发送，接收方根据周期取信号
* 统计时分复用 STDM： 为了减少时分复用的浪费，加标记
* 波分复用 WDM：  即光的频分复用

#### 宽带接入技术

* 非对称数字用户链路（ADSL）上网，电话打电话，用一个线路，互不影响，使用了DMT技术，即低频给电话，高频上网，高频中用频率分多个信道，少部分上行信道，大部分下行信道，并行通讯
    * ![1](/public/images/Image&#32;[6].png)
* ADSL的组成
    * ![1](/public/images/Image&#32;[7].png)

# 数据链路层

#### 基本概念

* 信道类型
    * 点对点信道 一对一
    * 广播信道  一对多广播通信方式，使用集线器、同轴电缆连接
* 链路
    * 链路： 点到点物理线路段
    * 数据链路： 物理线路+通信协议（通常是网卡）
* 帧
    * 帧头+数据报文+帧尾 

#### 三个问题

* 封装成帧： 帧头和帧尾，帧界定
* 透明传输： 如果数据里有跟帧尾一样的数据，需要在这个数据前面加转义字符，实现透明传输
* 差错控制： 
    * 循环冗余检验（CRC），数据除以约定的除数所得余数
    * 帧检验序列（FCS），FCS可以通过CRC得到，还有其他方法

#### 点到点信道，广域网

* PPP协议
    * 数据链路层协议： 可用于异步串行或同步串行介质
    * 链路控制协议（LCP）：建立数据链路层连接
    * 网络控制协议（NCP)： 允许使用多种网络层协议
![1](/public/images/Image&#32;[8].png)
    * 工作状态
        每次拨号，路由器调制解调器建立一跳物理连接，PC机向路由器发送一系列LCP分组，进行网络配置，NCP给新接入的PC分配一个临时IP，通信完毕会收回IP（DHCP协议？），释放数据链路层连接，最后释放物理层连接
        
#### 广播信道，局域网

* 拓扑
    星型网、总线型、环形网、树形网
    星型最多，使用集线器组网
* 协议
    * CSMA/CD协议： 
        * 多点接入： 多个计算机点的形式接入
        * 载波监听： 有碰撞检测（冲突检测），检测到冲突停止发送，只能半双工通信
    * 最小64字节，因为小于64的可能是由于冲突而异常种植的无效帧
* 以太网
    * 以太网是满足DI Ethernet V2的局域网 ,是最常用的局域网组网技术，是一种广播类型的网络，通俗的说，满足CSMA/CS协议的局域网就是以太网
    * mac帧，帧间最小间隔9.6us
      ![1](/public/images/Image&#32;[9].png)
    * 扩展以太网
        网桥： 连接多个以太网，能够检查帧的目的MAC地址，发送到相应的以太网
        交换机： 网桥发展过来，连接多个电脑，有网桥的功能，可以全双工，只发送到目标mac地址，可以存储转发，因此端口带宽独享
* 高速以太网
    速率达到100Mb/s
    全双工方式下工作，无冲突
    帧间最小间隔0.96us
     
# 网络层

#### 定义

* 负责在不同网络之间转发数据包，根据数据包的IP地址找到最快的下一跳地址并转发
* 不负责丢失重传或传输顺序 
* 网关是一种连接不同网络的设备，最常见的是路由器

#### 数据发送过程

1. 应用程序准备要发送的数据
2. 传输层 将文件分段并编号
3. 网络层 添加目标IP和源IP地址
4. 数据链路层 两种情况 使用自己的子网掩码 判断自己的网段和目标的网段 是否一致？ 一样的话使用arp协议广播解析目标IP地址的MAC地址；不一样的话用arp协议广播解析路由器MAC地址
5. 物理层 转换成数字信号、模拟信号发送


#### arp协议
* ARP 将目标IP，目标MAC地址，本机MAC地址，目的MAC地址是ffffffff，封装成帧，发到交换机。
* 交换机看到ffffffff后会将这个包广播到本网络所有主机
* 所有主机收到消息后检查主机IP是否匹配，匹配的主机把发送消息IP和MAC存到自己的缓存
* 匹配的主机回应消息，到发送方MAC，发送方将IP和MAC存到自己的缓存
* 用arp /a 命令可以看到arp缓存表

#### ICMP协议

* 为传输层提供服务，为了通知传输层是否丢包以及丢包的原因，让路由器报告传输错误的原因
* ping命令，TTL能计算通过了多少个路由器，Linux初始64，Windows初始128，Unix初始255，通过一个路由器减一
* pathping命令（仅windows），能看沿途的路由器，并计算路由器之间的延迟
* tracert命令，跟踪路由器路径

#### IGMP协议

* 组播(多播)：不同于点到点和广播，组播能够根据IP地址发送数据，只有配置了相应IP的组才能收到，类似频道的概念，特点是可以跨网段，节省带宽
* IGMP协议是组播管理协议，周期性的扫描本网段的主机，是否接受组播数据并转发

#### IP数据包

* 首部（固定20字节+可变（一般都没有））+数据（传输层）
![1](/public/images/Image&#32;[10].png)
* 版本： 是IPV4、IPV6等
* 首部长度： 标识首部长度
* 区分服务： 标识数据包的优先程度等内容
* 总长度： 数据包长度，最长65535，传输层一帧最长1500，因此若包的长度大于帧的最大长度，会把数据包分片，分成多个片在包装成帧
* 标识：分片是否属于同一个包
* 标志：是否是一个分片，是否是最后一个分片
* 片偏移量：当前分片在哪个位置
* 生存时间：即TTL，每过一个路由器生存时间-1，防止路由环路
* 协议： 数据部分协议，应该将数据交给哪个协议进程处理，TCP/DNS/UDP/ICMP等，每个协议对应一个协议号
* 首部检验和：把数据包首部反码求和再取反码，检验首部是否正确
* 原地址、目的地址：IP

#### IP协议

* 静态路由：管理员配置，决定下一跳地址
* 动态路由：路由器根据IP协议得到路由表，决定下一跳，IP协议有好几种如下
* RIP协议，周期性发广播到相邻的路由器，到上一个网段所需要经过的路由器数量，生成动态路由表，最大15跳，超出15跳认为不可到达，因此不适合大规模网络
* ospf协议，根据带宽而不是路由器数量

# 传输层

#### TCP协议
* 传输控制协议
* 将传输的文件分段传输，建立会话，可靠传输，流量控制
* 文件传输，发邮件，需要可靠、会话的传输

#### UDP协议
* 用户数据报协议
* 一个数据包就能完成通信，不用分段，不用会话，不可靠传输，不用流量控制
* DNS、QQ聊天，一对多的广播

#### 网络层、传输层和应用层的关系
* TCP/UDP协议+端口号能够标识应用层协议
* 传输层为应用进程提供了逻辑通讯，网络层是路由器到路由器，传输层程序进程到进程

#### UDP协议首部
![1](/public/images/Image&#32;[11].png)
* 首部一共8个字节
* 长度是首部+数据的长度
* 检验和计算3部分： 伪首部+首部+数据的检验和
* 伪首部包含了网络层信息，为了凑出20字节计算检验和

#### TCP
* 面向字节流，可靠通信，全双工通信
* 可靠传输：自动重传请求（停止等待协议，ARQ协议），一个一个包传输，只要没收到回复就认为传输失败，重新发，缺点是信道利用率低
* 流水线传输：连续发送多个分组（连续ARQ协议），维持一个滑动发送窗口保证可靠传输，累计确认技术保证传输速度

#### TCP-协议首部

* ![1](/public/images/Image&#32;[12].png)
* 首部为 20字节固定部分 + 变长部分， 最长60字节
* 序号： 分段之后的数据的在没分段时候的字节号，标注当前包的顺序
* 确认号： 当前数据包字节号的下一号，用于收到数据后返回这个号，让发送方知道发送成功，并从这个号继续发送
* 数据偏移：这个包从多少号开始首部结束，开始数据部分
* URG：当前包的优先级（urgent）
* ACK：确认号是否有效（ackowledge）
* SYN：为1则是建立会话的数据包（synchronized）
* 三次握手
    * 第一次 ACK=0，SYN=1，序号0，长度0，发起会话
    * 第二次 ACK=1，SYN=1，序号0，确认号1，服务器同意会话
    * 第三次 ACK=1，SYN=0，后续都一样
* PUS：接收方收到后，提前从缓冲区读取，URG是优先传输，PUS是优先给应用层
* RST：取消会话，如请求中关闭浏览器
* FIN：释放连接的请求
* 窗口：三次握手期间双方协商各自的缓存，也就是窗口
* 校验和：伪首部+首部+数据，前面也加12字节伪首部，同UDP类似
* 紧急指针： 在URG是1的时候起作用，指明数据中的紧急部分的结束位置
* 选项：有很多，例如：MSS，最大数据报文

#### TCP-可靠传输

1. 以字节为单位的滑动窗口技术，发送串口->接收窗口
2. 发送方发送发送窗口内的数据，接收方接收到后找到连续的数据返回确认的确认号，然后发送窗口和接收窗口都往后移动
3. 通过确认号来保证可靠传输不丢包

#### TCP-流量控制
* 为了让接收方能够有时间处理缓存中的数据，需要控制发送数据速度
* 通过协调窗口大小来控制
* 把发送窗口和接收窗口调小，流量就会变小，窗口为0，流量停止

#### TCP-传输连接管理
* 传输连接3个阶段： 连接建立、数据传输、连接释放
* 客户服务器模式，客户端发起，服务器接收
* ![1](/public/images/Image&#32;[13].png)
* ![1](/public/images/Image&#32;[14].png)
* ![1](/public/images/Image&#32;[15].png)
* ![1](/public/images/Image&#32;[16].png)
* ![1](/public/images/Image&#32;[17].png)
* ![1](/public/images/Image&#32;[18].png)
* ![1](/public/images/Image&#32;[19].png)


# 应用层

#### DNS协议

* 解析域名，返回IP
* 域名
    * 根：.
    * 顶级域名：com/edu/net/cn/org/gov
    * 二级域名：自由申请、baidu/sina/hang-hong
    * 三级域名：www.三级域名.二级域名.com
* nslookup 命令能看DNS结果 
* 解析是分布式的网络服务，当前DNS找不到域名时会一层层向上查找

#### DHCP协议

* 静态IP地址：IP固定
* 动态IP地址：动态IP，DHCP分配，分配IP、DNS、子网掩码、网关等
* DHCP可以跨网段，在网关上配置iphelpaddress后即可，请求分配IP的广播会被网关转发
* DHCP服务器地址一定是静态的

#### FTP协议（文件传输协议）

* 两个链接：
    * 21端口，TCP控制链接，用于传送命令
    * TCP数据链接，用于传送文件数据，两种模式
        * 主动模式：服务器端口20，服务器连客户端
        * 被动模式：ftp服务器打开端口，等待客户端链接
* FTP服务器端，如果有防火墙，要开20/21端口，通讯使用主动模式

#### TELNET协议（远程终端协议）

* 23端口，需要在Windows上面启动服务
* 测试某电脑端口是否打开，telnet 192.168.1.31 8080

#### HTTP协议

* 简单快速：客户向服务器请求服务时，只需传送请求方法和路径。请求方法常用的有GET、HEAD、POST。每种方法规定了客户与服务器联系的类型不同。
* 灵活：HTTP允许传输任意类型的数据对象。正在传输的类型由Content-Type加以标记。
* 无连接：无连接的含义是限制每次连接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开连接。采用这种方式可以节省传输时间。
* 无状态：HTTP协议是无状态协议。无状态是指协议对于事务处理没有记忆能力。缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能导致每次连接传送的数据量增大。另一方面，在服务器不需要先前信息时它的应答就较快。
* 支持B/S及C/S模式。
* ![1](/public/images/Image&#32;[20].png)
* ![1](/public/images/Image&#32;[21].png)
    * 状态行，由HTTP协议版本号， 状态码， 状态消息 三部分组成。第一行为状态行，（HTTP/1.1）表明HTTP版本为1.1版本，状态码为200，状态消息为（ok）
    * 第二部分：消息报头，用来说明客户端要使用的一些附加信息第二行和第三行为消息报头，Date:生成响应的日期和时间；Content-Type:指定了MIME类型的HTML(text/html),编码类型是UTF-8
    * 第三部分：空行，消息报头后面的空行是必须的
    * 第四部分：响应正文，服务器返回给客户端的文本信息。
* ![1](/public/images/Image&#32;[22].png)

#### 电子邮件相关协议
* SMTP：发邮件，邮件中继
* POP3：收邮件，
* IMAP：收邮件

